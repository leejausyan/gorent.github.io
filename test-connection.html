<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Supabase Connection</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">
  
  <div class="max-w-2xl w-full bg-gray-800 rounded-lg p-8 shadow-xl">
    <h1 class="text-3xl font-bold mb-6">üîç Test Supabase Connection</h1>
    
    <div id="results" class="space-y-4">
      <div class="bg-gray-700 p-4 rounded">
        <p class="font-semibold mb-2">Testing...</p>
        <div class="animate-pulse">Please wait...</div>
      </div>
    </div>
    
    <div class="mt-6">
      <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
        Test Ulang
      </button>
      <a href="index.html" class="ml-2 bg-green-600 hover:bg-green-700 px-4 py-2 rounded inline-block">
        Kembali ke Form
      </a>
    </div>
  </div>

  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Config -->
  <script src="config.js"></script>
  
  <script>
    const resultsDiv = document.getElementById('results');
    
    function addResult(icon, title, message, type = 'info') {
      const colors = {
        success: 'bg-green-900 border-green-500',
        error: 'bg-red-900 border-red-500',
        warning: 'bg-yellow-900 border-yellow-500',
        info: 'bg-blue-900 border-blue-500'
      };
      
      const result = document.createElement('div');
      result.className = `${colors[type]} border-l-4 p-4 rounded`;
      result.innerHTML = `
        <p class="font-semibold">${icon} ${title}</p>
        <p class="text-sm mt-1 opacity-90">${message}</p>
      `;
      resultsDiv.appendChild(result);
    }
    
    async function testConnection() {
      resultsDiv.innerHTML = '';
      
      // Test 1: Check Supabase SDK
      console.log('üîç Test 1: Checking Supabase SDK...');
      if (typeof window.supabase !== 'undefined') {
        addResult('‚úÖ', 'Supabase SDK Loaded', 'Supabase JS library berhasil dimuat dari CDN', 'success');
        console.log('‚úÖ Supabase SDK available');
      } else {
        addResult('‚ùå', 'Supabase SDK Not Found', 'Library Supabase tidak ditemukan. Cek koneksi internet.', 'error');
        console.error('‚ùå Supabase SDK not available');
        return;
      }
      
      // Test 2: Check Config
      console.log('üîç Test 2: Checking Config...');
      if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.url && window.SUPABASE_CONFIG.anonKey) {
        addResult('‚úÖ', 'Config Loaded', `URL: ${window.SUPABASE_CONFIG.url}`, 'success');
        console.log('‚úÖ Config loaded:', window.SUPABASE_CONFIG);
      } else {
        addResult('‚ùå', 'Config Error', 'Config tidak ditemukan atau tidak lengkap', 'error');
        console.error('‚ùå Config error');
        return;
      }
      
      // Test 3: Check Client
      console.log('üîç Test 3: Checking Supabase Client...');
      if (window.supabaseClient) {
        addResult('‚úÖ', 'Supabase Client Ready', 'Client berhasil diinisialisasi', 'success');
        console.log('‚úÖ Supabase client ready:', window.supabaseClient);
      } else {
        addResult('‚ùå', 'Client Not Initialized', 'Supabase client tidak terinisialisasi', 'error');
        console.error('‚ùå Client not initialized');
        return;
      }
      
      // Test 4: Test Connection
      console.log('üîç Test 4: Testing Database Connection...');
      try {
        const { data, error } = await window.supabaseClient
          .from('rentals')
          .select('id')
          .limit(1);
        
        if (error) {
          addResult('‚ùå', 'Database Connection Failed', `Error: ${error.message}`, 'error');
          console.error('‚ùå Database error:', error);
          
          // Check common errors
          if (error.message.includes('relation') && error.message.includes('does not exist')) {
            addResult('‚ö†Ô∏è', 'Table Not Found', 'Tabel "rentals" belum dibuat. Jalankan SQL setup di Supabase.', 'warning');
          }
        } else {
          addResult('‚úÖ', 'Database Connected', `Koneksi berhasil! ${data ? `Ditemukan ${data.length} record` : 'Tabel masih kosong'}`, 'success');
          console.log('‚úÖ Database connected. Data:', data);
        }
      } catch (err) {
        addResult('‚ùå', 'Connection Test Failed', err.message, 'error');
        console.error('‚ùå Connection test error:', err);
      }
      
      // Test 5: Test Storage
      console.log('üîç Test 5: Testing Storage...');
      try {
        const { data, error } = await window.supabaseClient
          .storage
          .getBucket('bukti-transfer');
        
        if (error) {
          if (error.message.includes('not found')) {
            addResult('‚ö†Ô∏è', 'Storage Bucket Not Found', 'Bucket "bukti-transfer" belum dibuat. Buat di Supabase Dashboard > Storage', 'warning');
          } else {
            addResult('‚ùå', 'Storage Error', error.message, 'error');
          }
          console.error('‚ùå Storage error:', error);
        } else {
          addResult('‚úÖ', 'Storage Ready', 'Bucket "bukti-transfer" ditemukan dan siap digunakan', 'success');
          console.log('‚úÖ Storage bucket found:', data);
        }
      } catch (err) {
        addResult('‚ö†Ô∏è', 'Storage Check Failed', 'Tidak dapat mengecek storage bucket', 'warning');
        console.error('‚ö†Ô∏è Storage check error:', err);
      }
      
      console.log('üèÅ Test selesai!');
    }
    
    // Run test when page loads
    setTimeout(testConnection, 100);
  </script>
  
</body>
</html>
